from kalman_filter import KalmanFilter
import numpy as np
import cv2
import math

measures_perfect =[
    [(518,1229), (534,1299), (655,1211)],
    [(515,1252), (526,1227), (663,1221)],
    [(516,1247), (525,1227), (665,1209)],
    [(516,1250), (526,1227), (660,1188)],
    [(516,1253), (528,1227), (656,1163)],
    [(518,1252), (529,1226), (657,1149)],
    [(521,1249), (531,1223), (658,1143)],
    [(528,1237), (537,1212), (659,1136)],
    [(534,1216), (540,1195), (663,1133)],
    [(538,1185), (540,1187), (667,1141)],
    [(542,1154), (543,1167), (670,1152)],
    [(544,1078), (542,1112), (668,1162)],
    [(550,1011), (544,1073), (666,1174)],
    [(558,965), (544,1055), (664,1185)],
    [(564,932), (543,1045), (662,1196)],
    [(569,899), (543,1033), (658,1210)],
    [(571,864), (543,1023), (650,1223)],
    [(573,829), (539,1041), (647,1228)],
    [(580,804), (533,1064), (646,1222)],
    [(590,791), (532,1074), (645,1220)],
    [(599,780), (529,1088), (637,1211)],
    [(608,779), (527,1099), (620,1184)],
    [(618,785), (525,1112), (605,1144)],
    [(628,792), (523,1131), (592,1106)],
    [(635,803), (521,1152), (585,1063)],
    [(639,823), (518,1176), (580,1009)],
    [(644,849), (524,1183), (575,955)],
    [(654,876), (526,1204), (571,924)],
    [(665,904), (528,1225), (564,897)],
    [(676,936), (532,1239), (556,870)],
    [(686,974), (538,1241), (546,845)],
    [(693,1008), (543,1220), (536,826)],
    [(701,1037), (553,1199), (532,826)],
    [(707,1057), (564,1183), (526,835)],
    [(708,1073), (574,1157), (521,823)],
    [(712,1093), (590,1103), (513,830)],
    [(709,1116), (595,1038), (505,839)],
    [(694,1136), (596,983), (501,856)],
    [(681,1155), (596,936), (500,881)],
    [(671,1172), (594,892), (498,908)],
    [(664,1190), (592,862), (495,938)],
    [(659,1206), (593,832), (492,970)],
    [(655,1215), (599,803), (490,1004)],
    [(647,1217), (603,785), (489,1030)],
    [(644,1223), (607,769), (482,1051)],
    [(635,1222), (610,754), (480,1062)],
    [(621,1197), (612,754), (479,1070)],
    [(606,1162), (615,763), (479,1084)],
    [(598,1136), (620,777), (479,1100)],
    [(588,1095), (626,792), (487,1117)],
    [(583,1042), (628,809), (492,1142)],
    [(578,989), (629,830), (497,1167)],
    [(573,939), (632,854), (504,1182)],
    [(569,902), (638,883), (501,1201)],
    [(565,882), (642,926), (501,1222)],
    [(560,862), (649,964), (504,1241)],
    [(554,838), (658,985), (509,1249)],
    [(548,814), (666,989), (517,1234)],
    [(546,797), (673,1000), (530,1218)],
    [(542,788), (680,1011), (546,1201)],
    [(536,793), (687,1024), (567,1180)],
    [(530,802), (691,1044), (588,1156)],
    [(527,816), (695,1065), (594,1102)],
    [(524,835), (699,1089), (595,1038)],
    [(522,858), (701,1115), (597,970)],
    [(519,885), (700,1142), (600,924)]
]

measures_imprecise =[
    [(518,1229), (534,1299), (655,1211)],
    [(515,1252), (526,1227), (663,1221)],
    [(516,1247), (525,1227), (660,1200)],
    [(516,1250), (526,1227), (660,1200)],
    [(516,1253), (528,1227), (660,1200)],
    [(518,1252), (529,1226), (660,1200)],
    [(521,1249), (531,1223), (660,1200)],
    [(528,1237), (537,1212), (660,1200)],
    [(534,1216), (540,1195), (663,1133)],
    [(538,1185), (540,1187), (667,1141)],
    [(542,1154), (543,1167), (670,1152)],
    [(544,1078), (542,1112), (668,1162)],
    [(550,1011), (544,1073), (666,1174)],
    [(558,965), (544,1055), (664,1185)],
    [(564,932), (543,1045), (100,100)],
    [(569,899), (543,1033), (658,1210)],
    [(571,864), (543,1023), (650,1223)],
    [(573,829), (539,1041), (647,1228)],
    [(580,804), (533,1064), (646,1222)],
    [(590,791), (532,1074), (645,1220)],
    [(599,780), (529,1088), (637,1211)],
    [(608,779), (527,1099), (100,100)],
    [(618,785), (525,1112), (605,1144)],
    [(628,792), (523,1131), (592,1106)],
    [(635,803), (521,1152), (585,1063)],
    [(639,823), (518,1176), (580,1009)],
    [(644,849), (524,1183), (575,955)],
    [(654,876), (526,1204), (571,924)],
    [(665,904), (528,1225), (560,890)],
    [(676,936), (532,1239), (550,870)],
    [(686,974), (538,1241), (540,840)],
    [(693,1008), (543,1220), (530,820)],
    [(701,1037), (553,1199), (532,826)],
    [(707,1057), (564,1183), (526,835)],
    [(708,1073), (574,1157), (521,823)],
    [(712,1093), (590,1103), (513,830)],
    [(709,1116), (595,1038), (505,839)],
    [(694,1136), (596,983), (501,856)],
    [(681,1155), (596,936), (500,881)],
    [(671,1172), (594,892), (498,908)],
    [(664,1190), (592,862), (495,938)],
    [(659,1206), (593,832), (492,970)],
    [(655,1215), (599,803), (390,994)],
    [(647,1217), (603,785), (389,930)],
    [(644,1223), (607,769), (382,951)],
    [(635,1222), (610,754), (480,1062)],
    [(621,1197), (612,754), (479,1070)],
    [(606,1162), (615,763), (479,1084)],
    [(598,1136), (620,777), (479,1100)],
    [(588,1095), (626,792), (487,1117)],
    [(583,1042), (628,809), (492,1142)],
    [(578,989), (629,830), (497,1167)],
    [(573,939), (632,854), (497,1182)],
    [(569,902), (638,883), (497,1201)],
    [(565,882), (642,926), (497,1222)],
    [(560,862), (649,964), (497,1241)],
    [(554,838), (658,985), (509,1249)],
    [(548,814), (666,989), (517,1249)],
    [(546,797), (673,1000), (530,1249)],
    [(542,788), (680,1011), (546,1249)],
    [(536,793), (687,1024), (567,1249)],
    [(530,802), (691,1044), (588,1156)],
    [(527,816), (695,1065), (594,1102)],
    [(524,835), (699,1089), (595,1038)],
    [(522,858), (701,1115), (597,970)],
    [(519,885), (700,1142), (600,924)]
]

measures_gap =[
    [(518,1229), (534,1299), (655,1211)],
    [(515,1252), (526,1227), (663,1221)],
    [(516,1247), (525,1227), (665,1209)],
    [(516,1250), (526,1227), (660,1188)],
    [(516,1253), (528,1227), (656,1163)],
    [(518,1252), (529,1226), (657,1149)],
    [(521,1249), (531,1223), (658,1143)],
    [(528,1237), (537,1212), (659,1136)],
    [(534,1216), (540,1195), (663,1133)],
    [(538,1185), (540,1187), (667,1141)],
    [(542,1154), (543,1167), (670,1152)],
    [(544,1078), (542,1112), (668,1162)],
    [(550,1011), (544,1073), (666,1174)],
    [(558,965), (544,1055), (664,1185)],
    [(564,932), (543,1045), (662,1196)],
    [(569,899), (543,1033), (658,1210)],
    [(571,864), (543,1023), (650,1223)],
    [(573,829), (539,1041), (647,1228)],
    [(580,804), (533,1064), None],
    [(590,791), (532,1074), None],
    [(599,780), (529,1088), None],
    [(608,779), (527,1099), (620,1184)],
    [(618,785), (525,1112), (605,1144)],
    [(628,792), (523,1131), (592,1106)],
    [(635,803), (521,1152), (585,1063)],
    [(639,823), (518,1176), (580,1009)],
    [(644,849), (524,1183), (575,955)],
    [(654,876), (526,1204), (571,924)],
    [(665,904), (528,1225), (564,897)],
    [(676,936), (532,1239), (556,870)],
    [(686,974), (538,1241), (546,845)],
    [(693,1008), (543,1220), (536,826)],
    [(701,1037), (553,1199), None],
    [(707,1057), (564,1183), None],
    [(708,1073), (574,1157), None],
    [(712,1093), (590,1103), None],
    [(709,1116), (595,1038), None],
    [(694,1136), (596,983), (501,856)],
    [(681,1155), (596,936), (500,881)],
    [(671,1172), (594,892), (498,908)],
    [(664,1190), (592,862), (495,938)],
    [(659,1206), (593,832), (492,970)],
    [(655,1215), (599,803), (490,1004)],
    [(647,1217), (603,785), (489,1030)],
    [(644,1223), (607,769), (482,1051)],
    [(635,1222), (610,754), (480,1062)],
    [(621,1197), (612,754), (479,1070)],
    [(606,1162), (615,763), (479,1084)],
    [(598,1136), (620,777), (479,1100)],
    [(588,1095), (626,792), (487,1117)],
    [(583,1042), (628,809), (492,1142)],
    [(578,989), (629,830), None],
    [(573,939), (632,854), None],
    [(569,902), (638,883), None],
    [(565,882), (642,926), None],
    [(560,862), (649,964), None],
    [(554,838), (658,985), None],
    [(548,814), (666,989), None],
    [(546,797), (673,1000), None],
    [(542,788), (680,1011), None],
    [(536,793), (687,1024), None],
    [(530,802), (691,1044), (588,1156)],
    [(527,816), (695,1065), (594,1102)],
    [(524,835), (699,1089), (595,1038)],
    [(522,858), (701,1115), (597,970)],
    [(519,885), (700,1142), (600,924)]
]

measures_noise =[
    [(518,1229), (534,1299), (655,1211)],
    [(515,1252), (526,1227), (663,1221)],
    [(516,1247), (525,1227), (665,1209)],
    [(516,1250), (526,1227), (660,1188)],
    [(516,1253), (528,1227), (656,1163)],
    [(518,1252), (529,1226), (657,1149)],
    [(521,1249), (531,1223), (658,1143)],
    [(528,1237), (537,1212), (659,1136)],
    [(534,1216), (540,1195), (663,1133)],
    [(538,1185), (540,1187), (667,1141)],
    [(542,1154), (543,1167), (670,1152)],
    [(544,1078), (542,1112), (668,1162)],
    [(550,1011), (544,1073), (666,1174), (300,300)],
    [(558,965), (544,1055), (664,1185), (300,300)],
    [(564,932), (543,1045), (662,1196), (300,300)],
    [(569,899), (543,1033), (658,1210), (300,300)],
    [(571,864), (543,1023), (650,1223)],
    [(573,829), (539,1041), (647,1228)],
    [(580,804), (533,1064), (646,1222)],
    [(590,791), (532,1074), (645,1220)],
    [(599,780), (529,1088), (637,1211)],
    [(608,779), (527,1099), (620,1184)],
    [(618,785), (525,1112), (605,1144)],
    [(628,792), (523,1131), (592,1106)],
    [(635,803), (521,1152), (585,1063)],
    [(639,823), (518,1176), (580,1009)],
    [(644,849), (524,1183), (575,955)],
    [(654,876), (526,1204), (571,924)],
    [(665,904), (528,1225), (564,897)],
    [(676,936), (532,1239), (556,870)],
    [(686,974), (538,1241), (546,845)],
    [(693,1008), (543,1220), (536,826)],
    [(701,1037), (553,1199), (532,826)],
    [(707,1057), (564,1183), (526,835)],
    [(708,1073), (574,1157), (521,823)],
    [(712,1093), (300,300), (590,1103), (513,830)],
    [(709,1116), (300,300), (595,1038), (505,839)],
    [(694,1136), (300,300), (596,983), (501,856)],
    [(681,1155), (300,300), (596,936), (500,881)],
    [(671,1172), (594,892), (498,908)],
    [(664,1190), (592,862), (495,938)],
    [(659,1206), (593,832), (492,970)],
    [(655,1215), (599,803), (490,1004)],
    [(647,1217), (603,785), (489,1030)],
    [(644,1223), (607,769), (482,1051)],
    [(635,1222), (610,754), (480,1062)],
    [(621,1197), (612,754), (479,1070)],
    [(606,1162), (615,763), (479,1084)],
    [(598,1136), (620,777), (479,1100)],
    [(588,1095), (626,792), (487,1117)],
    [(583,1042), (628,809), (492,1142)],
    [(578,989), (629,830), (497,1167)],
    [(573,939), (632,854), (300,300), (504,1182)],
    [(569,902), (638,883), (400,300), (501,1201)],
    [(565,882), (642,926), (500,300), (501,1222)],
    [(560,862), (649,964), (600,300), (504,1241)],
    [(554,838), (658,985), (509,1249)],
    [(548,814), (666,989), (517,1234)],
    [(546,797), (673,1000), (530,1218)],
    [(542,788), (680,1011), (546,1201)],
    [(536,793), (687,1024), (567,1180)],
    [(530,802), (691,1044), (588,1156)],
    [(527,816), (695,1065), (594,1102)],
    [(524,835), (699,1089), (595,1038)],
    [(522,858), (701,1115), (597,970)],
    [(519,885), (700,1142), (600,924)]
]
# 37.05242424242427 < 37.05484848484852 0.1 14 30 31 0.1 0.1
dt, u_x,u_y, std_acc, x_std_meas, y_std_meas = 0.1, 14, 30, 31, 0.1, 0.1
cv2.namedWindow('img', cv2.WINDOW_NORMAL)
ids = {}
for measure_list in measures_perfect:
    if len(ids) == 0:
        for measure in measure_list:
            measure_data = {}
            measure_data["Coord"] = measure
            measure_data["Hist"] = []
            KF = KalmanFilter(dt, u_x,u_y, std_acc, x_std_meas, y_std_meas)
            KF.update(np.array([[measure[0]], [measure[1]]]))
            (x,y) = KF.predict()
            measure_data["KalmanFilter"] = KF
            # Dado que la primera prediccion no es precisa se guarda las coordenadas
            measure_data["Prediction"] = measure
            measure_data["HistPrediction"] = []
            measure_data["Matched"] = False
            ids[len(ids)] = measure_data
    else:
        limit_dist = 3000 # TODO sacar parametro
        # Crear matriz de distancias
        dist_matrix = np.zeros((len(measure_list),len(ids)))

        for idx,prev_c in enumerate(ids):
            for jdx, curr_c in enumerate(measure_list):
                prev_center = ids[idx]["Prediction"]
                curr_center = measure_list[jdx]
                if curr_center is None:
                    dist_matrix[jdx,idx] = -1
                else:
                    curr_dist =  math.dist(prev_center, curr_center)
                    dist_matrix[jdx,idx] = curr_dist
        
        #Asignar según la distancia de la matriz sea mínima
        max_dist = np.max(dist_matrix)
        #Queremos encontrar todas las coincidencias por debajo de la distancia maxima
        for i in range(len(measure_list)):
            min_dist = dist_matrix.argmin()
            # Coords de la distancia minima en toda la matriz
            min_value_index = np.unravel_index(min_dist, dist_matrix.shape)
            # TODO Comprobar que es min_value_index[0] y no de [1]
            # Como la matriz es coords_nuevas \ coords_antiguas, sacamos los indices
            measure_list_index = min_value_index[0]
            ids_index = min_value_index[1]
            # Haces la asignación
            if 0 <= dist_matrix[measure_list_index,ids_index] <= limit_dist:
                # Guardo la coordenada en el historial
                ids[ids_index]["Hist"].append(ids[ids_index]["Coord"])
                # Asigno la nueva coordenada
                ids[ids_index]["Coord"] = measure_list[measure_list_index]
                # Actualizo el filtro de Kalman
                ids[ids_index]["KalmanFilter"].update(np.array([[measure_list[measure_list_index][0]], [measure_list[measure_list_index][1]]]))
                # Reinicio el historial de predicciones
                new_predictions = []
                new_predictions.append(ids[ids_index]["Prediction"])
                ids[ids_index]["HistPrediction"] = new_predictions
                # Hago la nueva prediccion
                ids[ids_index]["Prediction"] = ids[ids_index]["KalmanFilter"].predict()
                # Lo marco como encontrado
                ids[ids_index]["Matched"] = True
            # Creas nuevo id
            elif dist_matrix[measure_list_index,ids_index] > 0:
                measure_data = {}
                measure_data["Coord"] = measure_list[measure_list_index]
                measure_data["Hist"] = []
                KF = KalmanFilter(dt, u_x,u_y, std_acc, x_std_meas, y_std_meas)
                (x,y) = KF.predict()
                measure_data["KalmanFilter"] = KF
                # Dado que la primera prediccion no es precisa se guarda las coordenadas
                measure_data["Prediction"] = measure_list[measure_list_index]
                measure_data["HistPrediction"] = []
                measure_data["Matched"] = False
                ids[len(ids)] = measure_data
            
            # Quitas tanto el id como la deteccion para futuras asignaciones, si las coordenadas
            # eran None simplemente quitas esa fila
            if dist_matrix[measure_list_index,ids_index] == -1:
                dist_matrix[measure_list_index,:] = max_dist+1
            else:
                dist_matrix[measure_list_index,:] = max_dist+1
                dist_matrix[:,ids_index] = max_dist+1

        # Actualizar detecciones perdidas
        accumulate_predictions_limit = 10 # TODO sacar parametro
        for key in ids:
            elem = ids[key]
            if elem["Matched"] == False:
                if len(elem["HistPrediction"])<=accumulate_predictions_limit:
                    # Guardo la coordenada en el historial
                    elem["Hist"].append(elem["Coord"])
                    (x,y) = elem["KalmanFilter"].predict()
                    # Predict devuelve una matriz por coordenada con solo ese valor, por lo que lo extraemos
                    x = x.max()
                    y = y.max()
                    # Asigno la prediccion como nueva coordenada
                    elem["Coord"] = (x,y)
                    # Actualizo el filtro de Kalman
                    elem["KalmanFilter"].update(np.array([[x], [y]]))
                    # Guardo la última predicción en el historial
                    elem["HistPrediction"].append(elem["Prediction"])
                    # Hago la nueva prediccion
                    elem["Prediction"] = (x,y)
            # Lo dejo en falso para siguientes iteraciones
            else:
                elem["Matched"] = False


    height, width = 1920, 1080
    img = np.zeros((height, width, 3), np.uint8)
    img[:, :] = [255, 255, 255]

    for idx, measure in enumerate(measure_list):
        cv2.circle(img, measure, 10, (255, 0, 0), 2)
        cv2.putText(img, "Measure {}".format(idx), measure, 0, 0.5, (255, 0, 0), 2)
    
    for key in ids:
        elem = ids[key]
        """ x1, y1 = elem["Prediction"]
        cv2.rectangle(img, (int(x1 - 15), int(y1 - 15)), (int(x1 + 15), int(y1 + 15)), (0, 0, 255), 2)
        cv2.putText(img, "Prediccion siguiente {}".format(key), (int(x1 + 15), int(y1 + 10)), 0, 0.5, (0, 0, 255), 2)
        if len(elem["HistPrediction"])>0:
            x2, y2 = elem["HistPrediction"][0]
            cv2.rectangle(img, (int(x2 - 15), int(y2 - 15)), (int(x2 + 15), int(y2 + 15)), (0, 255, 0), 2)
            cv2.putText(img, "Predcion actual {}".format(key), (int(x2 + 15), int(y2 + 10)), 0, 0.5, (0, 255, 0), 2) """
        """ if key == 2 and len(elem["HistPrediction"])>1:
            x1, y1 = elem["Coord"]
            cv2.rectangle(img, (int(x1 - 15), int(y1 - 15)), (int(x1 + 15), int(y1 + 15)), (0, 0, 255), 2)
            cv2.putText(img, "Asignacion {}".format(key), (int(x1 + 15), int(y1 + 10)), 0, 0.5, (0, 0, 255), 2) """
        x1, y1 = elem["Coord"]
        cv2.putText(img, "Id {}".format(key), (int(x1 + 15), int(y1 + 10)), 0, 0.5, (0, 0, 255), 2)
    
    #img = cv2.resize(img, (960, 540))
    cv2.imshow('img', img)
    cv2.waitKey(0)

cv2.destroyAllWindows() 